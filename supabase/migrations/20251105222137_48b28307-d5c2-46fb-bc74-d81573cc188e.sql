-- PHASE 2 FINAL : IMPORT PLAN COMPTABLE OHADA ET CRÉATION JOURNAUX

DO $$
DECLARE pharmacy_record RECORD;
BEGIN
  FOR pharmacy_record IN SELECT id FROM public.pharmacies WHERE id IS NOT NULL
  LOOP
    INSERT INTO public.plan_comptable (tenant_id, numero_compte, libelle_compte, type_compte, classe, is_active) VALUES
    (pharmacy_record.id, '10', 'Capital', 'detail', 1, true),(pharmacy_record.id, '101', 'Capital social', 'detail', 1, true),(pharmacy_record.id, '11', 'Réserves', 'detail', 1, true),(pharmacy_record.id, '12', 'Report à nouveau', 'detail', 1, true),(pharmacy_record.id, '13', 'Résultat net de l''exercice', 'detail', 1, true),(pharmacy_record.id, '14', 'Subventions d''investissement', 'detail', 1, true),(pharmacy_record.id, '15', 'Provisions réglementées', 'detail', 1, true),(pharmacy_record.id, '16', 'Emprunts et dettes assimilées', 'detail', 1, true),(pharmacy_record.id, '161', 'Emprunts obligataires', 'detail', 1, true),(pharmacy_record.id, '162', 'Emprunts auprès des établissements de crédit', 'detail', 1, true),(pharmacy_record.id, '18', 'Dettes liées à des participations', 'detail', 1, true),(pharmacy_record.id, '20', 'Charges immobilisées', 'detail', 2, true),(pharmacy_record.id, '21', 'Immobilisations incorporelles', 'detail', 2, true),(pharmacy_record.id, '211', 'Frais de développement et de prospection', 'detail', 2, true),(pharmacy_record.id, '213', 'Logiciels', 'detail', 2, true),(pharmacy_record.id, '22', 'Terrains', 'detail', 2, true),(pharmacy_record.id, '23', 'Bâtiments, installations techniques et agencements', 'detail', 2, true),(pharmacy_record.id, '231', 'Bâtiments', 'detail', 2, true),(pharmacy_record.id, '24', 'Matériel', 'detail', 2, true),(pharmacy_record.id, '241', 'Matériel et outillage industriel et commercial', 'detail', 2, true),(pharmacy_record.id, '244', 'Matériel de bureau', 'detail', 2, true),(pharmacy_record.id, '245', 'Matériel informatique', 'detail', 2, true),(pharmacy_record.id, '28', 'Amortissements', 'detail', 2, true),(pharmacy_record.id, '281', 'Amortissements des immobilisations incorporelles', 'detail', 2, true),(pharmacy_record.id, '283', 'Amortissements des bâtiments', 'detail', 2, true),(pharmacy_record.id, '284', 'Amortissements du matériel', 'detail', 2, true),(pharmacy_record.id, '31', 'Marchandises', 'detail', 3, true),(pharmacy_record.id, '311', 'Médicaments', 'detail', 3, true),(pharmacy_record.id, '312', 'Parapharmacie', 'detail', 3, true),(pharmacy_record.id, '32', 'Matières premières et fournitures liées', 'detail', 3, true),(pharmacy_record.id, '33', 'Autres approvisionnements', 'detail', 3, true),(pharmacy_record.id, '38', 'Achats stockés', 'detail', 3, true),(pharmacy_record.id, '39', 'Dépréciations des stocks', 'detail', 3, true),(pharmacy_record.id, '40', 'Fournisseurs et comptes rattachés', 'detail', 4, true),(pharmacy_record.id, '401', 'Fournisseurs', 'detail', 4, true),(pharmacy_record.id, '4011', 'Fournisseurs de médicaments', 'detail', 4, true),(pharmacy_record.id, '4012', 'Fournisseurs de parapharmacie', 'detail', 4, true),(pharmacy_record.id, '408', 'Fournisseurs - Factures non parvenues', 'detail', 4, true),(pharmacy_record.id, '409', 'Fournisseurs débiteurs', 'detail', 4, true),(pharmacy_record.id, '41', 'Clients et comptes rattachés', 'detail', 4, true),(pharmacy_record.id, '411', 'Clients', 'detail', 4, true),(pharmacy_record.id, '4111', 'Clients particuliers', 'detail', 4, true),(pharmacy_record.id, '4112', 'Clients assurances', 'detail', 4, true),(pharmacy_record.id, '4113', 'Clients mutuelles', 'detail', 4, true),(pharmacy_record.id, '416', 'Clients douteux', 'detail', 4, true),(pharmacy_record.id, '418', 'Clients - Produits à recevoir', 'detail', 4, true),(pharmacy_record.id, '419', 'Clients créditeurs', 'detail', 4, true),(pharmacy_record.id, '42', 'Personnel', 'detail', 4, true),(pharmacy_record.id, '421', 'Personnel - Rémunérations dues', 'detail', 4, true),(pharmacy_record.id, '422', 'Personnel - Charges à payer', 'detail', 4, true),(pharmacy_record.id, '43', 'Organismes sociaux', 'detail', 4, true),(pharmacy_record.id, '431', 'Sécurité sociale', 'detail', 4, true),(pharmacy_record.id, '44', 'État et collectivités publiques', 'detail', 4, true),(pharmacy_record.id, '441', 'État - Subventions à recevoir', 'detail', 4, true),(pharmacy_record.id, '442', 'État - Impôts et taxes recouvrables', 'detail', 4, true),(pharmacy_record.id, '443', 'Opérations particulières avec l''État', 'detail', 4, true),(pharmacy_record.id, '444', 'État - Impôts sur les bénéfices', 'detail', 4, true),(pharmacy_record.id, '445', 'État - Taxes sur le chiffre d''affaires', 'detail', 4, true),(pharmacy_record.id, '4451', 'TVA à décaisser', 'detail', 4, true),(pharmacy_record.id, '4452', 'TVA déductible', 'detail', 4, true),(pharmacy_record.id, '4456', 'TVA à régulariser', 'detail', 4, true),(pharmacy_record.id, '446', 'État - Autres impôts et taxes', 'detail', 4, true),(pharmacy_record.id, '47', 'Débiteurs et créditeurs divers', 'detail', 4, true),(pharmacy_record.id, '471', 'Comptes d''attente', 'detail', 4, true),(pharmacy_record.id, '475', 'Associés - Comptes courants', 'detail', 4, true),(pharmacy_record.id, '478', 'Autres débiteurs et créditeurs divers', 'detail', 4, true),(pharmacy_record.id, '49', 'Dépréciations et risques provisionnés', 'detail', 4, true),(pharmacy_record.id, '50', 'Titres de placement', 'detail', 5, true),(pharmacy_record.id, '51', 'Banques, établissements financiers et assimilés', 'detail', 5, true),(pharmacy_record.id, '511', 'Valeurs à l''encaissement', 'detail', 5, true),(pharmacy_record.id, '512', 'Banques', 'detail', 5, true),(pharmacy_record.id, '5121', 'Compte bancaire principal', 'detail', 5, true),(pharmacy_record.id, '5122', 'Compte bancaire secondaire', 'detail', 5, true),(pharmacy_record.id, '52', 'Instruments de trésorerie', 'detail', 5, true),(pharmacy_record.id, '53', 'Caisse', 'detail', 5, true),(pharmacy_record.id, '531', 'Caisse siège social', 'detail', 5, true),(pharmacy_record.id, '5311', 'Caisse principale', 'detail', 5, true),(pharmacy_record.id, '5312', 'Caisse secondaire', 'detail', 5, true),(pharmacy_record.id, '54', 'Régies d''avances et accréditifs', 'detail', 5, true),(pharmacy_record.id, '58', 'Virements internes', 'detail', 5, true),(pharmacy_record.id, '59', 'Dépréciations et risques provisionnés', 'detail', 5, true),(pharmacy_record.id, '60', 'Achats et variations de stocks', 'detail', 6, true),(pharmacy_record.id, '601', 'Achats de marchandises', 'detail', 6, true),(pharmacy_record.id, '6011', 'Achats de médicaments', 'detail', 6, true),(pharmacy_record.id, '6012', 'Achats de parapharmacie', 'detail', 6, true),(pharmacy_record.id, '602', 'Achats de matières premières', 'detail', 6, true),(pharmacy_record.id, '604', 'Achats stockés de matières et fournitures consommables', 'detail', 6, true),(pharmacy_record.id, '605', 'Autres achats', 'detail', 6, true),(pharmacy_record.id, '608', 'Achats d''emballages', 'detail', 6, true),(pharmacy_record.id, '609', 'Rabais, remises et ristournes obtenus sur achats', 'detail', 6, true),(pharmacy_record.id, '61', 'Transports', 'detail', 6, true),(pharmacy_record.id, '611', 'Transports sur achats', 'detail', 6, true),(pharmacy_record.id, '612', 'Transports sur ventes', 'detail', 6, true),(pharmacy_record.id, '62', 'Services extérieurs A', 'detail', 6, true),(pharmacy_record.id, '621', 'Sous-traitance générale', 'detail', 6, true),(pharmacy_record.id, '622', 'Locations et charges locatives', 'detail', 6, true),(pharmacy_record.id, '623', 'Redevances de crédit-bail', 'detail', 6, true),(pharmacy_record.id, '624', 'Entretien, réparations et maintenance', 'detail', 6, true),(pharmacy_record.id, '625', 'Primes d''assurances', 'detail', 6, true),(pharmacy_record.id, '626', 'Études, recherches et documentation', 'detail', 6, true),(pharmacy_record.id, '627', 'Publicité, publications et relations publiques', 'detail', 6, true),(pharmacy_record.id, '63', 'Services extérieurs B', 'detail', 6, true),(pharmacy_record.id, '631', 'Frais bancaires', 'detail', 6, true),(pharmacy_record.id, '632', 'Rémunérations d''intermédiaires et de conseils', 'detail', 6, true),(pharmacy_record.id, '633', 'Frais de formation du personnel', 'detail', 6, true),(pharmacy_record.id, '634', 'Redevances pour brevets, licences, logiciels', 'detail', 6, true),(pharmacy_record.id, '64', 'Impôts et taxes', 'detail', 6, true),(pharmacy_record.id, '641', 'Impôts et taxes directs', 'detail', 6, true),(pharmacy_record.id, '645', 'Impôts et taxes indirects', 'detail', 6, true),(pharmacy_record.id, '646', 'Droits d''enregistrement', 'detail', 6, true),(pharmacy_record.id, '65', 'Autres charges', 'detail', 6, true),(pharmacy_record.id, '651', 'Redevances pour concessions, brevets', 'detail', 6, true),(pharmacy_record.id, '652', 'Moins-values sur sorties d''actifs immobilisés', 'detail', 6, true),(pharmacy_record.id, '66', 'Charges de personnel', 'detail', 6, true),(pharmacy_record.id, '661', 'Rémunérations directes versées au personnel', 'detail', 6, true),(pharmacy_record.id, '662', 'Indemnités et avantages divers', 'detail', 6, true),(pharmacy_record.id, '663', 'Charges sociales', 'detail', 6, true),(pharmacy_record.id, '664', 'Charges sociales de l''exploitant individuel', 'detail', 6, true),(pharmacy_record.id, '67', 'Frais financiers et charges assimilées', 'detail', 6, true),(pharmacy_record.id, '671', 'Intérêts des emprunts', 'detail', 6, true),(pharmacy_record.id, '672', 'Intérêts dans loyers de crédit-bail', 'detail', 6, true),(pharmacy_record.id, '673', 'Escomptes accordés', 'detail', 6, true),(pharmacy_record.id, '68', 'Dotations aux amortissements', 'detail', 6, true),(pharmacy_record.id, '681', 'Dotations aux amortissements d''exploitation', 'detail', 6, true),(pharmacy_record.id, '69', 'Dotations aux provisions', 'detail', 6, true),(pharmacy_record.id, '70', 'Ventes', 'detail', 7, true),(pharmacy_record.id, '701', 'Ventes de marchandises', 'detail', 7, true),(pharmacy_record.id, '7011', 'Ventes de médicaments', 'detail', 7, true),(pharmacy_record.id, '7012', 'Ventes de parapharmacie', 'detail', 7, true),(pharmacy_record.id, '702', 'Ventes de produits finis', 'detail', 7, true),(pharmacy_record.id, '703', 'Ventes de produits intermédiaires', 'detail', 7, true),(pharmacy_record.id, '704', 'Ventes de produits résiduels', 'detail', 7, true),(pharmacy_record.id, '706', 'Services vendus', 'detail', 7, true),(pharmacy_record.id, '707', 'Produits accessoires', 'detail', 7, true),(pharmacy_record.id, '709', 'Rabais, remises et ristournes accordés', 'detail', 7, true),(pharmacy_record.id, '71', 'Subventions d''exploitation', 'detail', 7, true),(pharmacy_record.id, '72', 'Production immobilisée', 'detail', 7, true),(pharmacy_record.id, '73', 'Variation des stocks de biens et services produits', 'detail', 7, true),(pharmacy_record.id, '74', 'Autres produits', 'detail', 7, true),(pharmacy_record.id, '75', 'Autres produits', 'detail', 7, true),(pharmacy_record.id, '77', 'Revenus financiers et produits assimilés', 'detail', 7, true),(pharmacy_record.id, '771', 'Intérêts de prêts', 'detail', 7, true),(pharmacy_record.id, '772', 'Revenus des titres de participation', 'detail', 7, true),(pharmacy_record.id, '773', 'Escomptes obtenus', 'detail', 7, true),(pharmacy_record.id, '78', 'Reprises sur amortissements', 'detail', 7, true),(pharmacy_record.id, '79', 'Reprises sur provisions', 'detail', 7, true),(pharmacy_record.id, '80', 'Engagements', 'detail', 8, true),(pharmacy_record.id, '81', 'Valeurs en instance de régularisation', 'detail', 8, true),(pharmacy_record.id, '89', 'Bilan', 'detail', 8, true)
    ON CONFLICT (tenant_id, numero_compte) DO NOTHING;

    INSERT INTO public.journaux_comptables (tenant_id, code_journal, libelle_journal, type_journal, is_active) VALUES
    (pharmacy_record.id, 'VT', 'Journal des ventes', 'Ventes', true),(pharmacy_record.id, 'AC', 'Journal des achats', 'Achats', true),(pharmacy_record.id, 'BQ', 'Journal de banque', 'Banque', true),(pharmacy_record.id, 'CA', 'Journal de caisse', 'Caisse', true),(pharmacy_record.id, 'OD', 'Journal opérations diverses', 'Operations_Diverses', true)
    ON CONFLICT (tenant_id, code_journal) DO NOTHING;

    IF NOT EXISTS (SELECT 1 FROM public.exercices_comptables WHERE tenant_id = pharmacy_record.id AND libelle_exercice = 'Exercice 2025') THEN
      INSERT INTO public.exercices_comptables (tenant_id, libelle_exercice, date_debut, date_fin, statut) 
      VALUES (pharmacy_record.id, 'Exercice 2025', '2025-01-01'::date, '2025-12-31'::date, 'Ouvert');
    END IF;
  END LOOP;
END$$;